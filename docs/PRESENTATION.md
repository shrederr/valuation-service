# Презентация: Сервис оценки ликвидности недвижимости

## Демо-доступ
- **URL:** http://localhost:3001/
- **API:** http://localhost:3001/api/v1/valuation/{id}/full

---

## 1. ЧТО РЕАЛИЗОВАНО

### 1.1 Основной функционал

| Компонент | Статус | Описание |
|-----------|--------|----------|
| Подбор аналогов | ✅ Готово | 7-уровневый географический поиск |
| Справедливая цена | ✅ Готово | Медиана, среднее, диапазон Q1-Q3 |
| Скоринг ликвидности | ✅ Готово | 9 критериев с весами |
| Время продажи | ✅ Готово | На основе реальных данных рынка |
| Веб-интерфейс | ✅ Готово | Поиск по ID и URL |

### 1.2 Алгоритм подбора аналогов (приоритеты)

```
1. Тот же дом (улица + номер) или ЖК
2. Тот же квартал (радиус 200м)
3. Та же улица
4. Та же топзона (микрорайон)
5. Тот же район
6. Соседние районы
7. Весь город

Цель: 10 аналогов | Мин: 5 | Макс: 20
```

### 1.3 Критерии ликвидности

| Критерий | Вес | Источник данных |
|----------|-----|-----------------|
| Цена vs рынок | 20% | Сравнение с медианой аналогов |
| Время экспозиции | 8% | Реальные данные (created_at → deleted_at) |
| Конкуренция | 5% | Количество аналогов в локации |
| Локация | 10% | ЖК, топзона, улица |
| Состояние | 9% | ⚠️ Нет данных |
| Формат (комнаты) | 7% | Есть данные |
| Этаж | 6% | Есть данные |
| Тип дома | 5% | ⚠️ Нет данных |
| Цена за м² | 3% | Рассчитывается |

### 1.4 Расчет времени продажи

**Медианное время из реальных данных (762K проданных объектов):**

| Тип | Медиана | Среднее |
|-----|---------|---------|
| Квартиры | 30 дней | 70 дней |
| Дома | 58 дней | 91 день |
| Коммерция | 51 день | 90 дней |
| Участки | 68 дней | 112 дней |

**Формула:** `estimatedDays = медиана × коэффициент_скоринга`
- Скоринг 10 → ×0.5 (быстрее)
- Скоринг 5 → ×1.0 (норма)
- Скоринг 0 → ×2.0 (дольше)

---

## 2. ПРИМЕРЫ ДЛЯ ДЕМОНСТРАЦИИ

### 2.1 Хороший пример (DOM.RIA с номером дома)

**Объект:** 1-комнатная, 31 м², 12 этаж, $43,500
```
UUID: 8688114a-261e-4424-9376-3a3e6a143304
Source ID: 413783

API: http://localhost:3001/api/v1/valuation/8688114a-261e-4424-9376-3a3e6a143304/full

Преимущества:
- Есть номер дома → поиск начинается с "того же дома"
- Данные более полные
```

### 2.2 Типичный OLX (без номера дома)

**Объект:** 1-комнатная, 39 м², 2 этаж, $52,000
```
UUID: 6c9a8d81-083a-4b46-bddc-075ef10bb2fe
Source ID: 941274

API: http://localhost:3001/api/v1/valuation/6c9a8d81-083a-4b46-bddc-075ef10bb2fe/full

Проблема:
- Нет номера дома → поиск начинается с уровня "квартал" или "улица"
```

### 2.3 Пример 2-комнатной квартиры

**Объект:** 2-комнатная, 60 м², 12 этаж, $61,000
```
UUID: 4151e640-6e9d-484c-af02-a9d0db432ca2
Source ID: 1019853

API: http://localhost:3001/api/v1/valuation/4151e640-6e9d-484c-af02-a9d0db432ca2/full
```

### 2.4 Проблемный пример (несоответствие адреса)

**Объект из заметок:**
```
URL: https://www.olx.ua/d/uk/obyavlenie/prodam-2-komnatnuyu-kvartiru-v-zhk-7-samuraev-na-balkovskoy-IDZsiX8.html

Проблема: Адрес на карте OLX не соответствует адресу в заголовке объявления
```

---

## 3. ТЕКУЩИЕ ПРОБЛЕМЫ И РЕШЕНИЯ

### 3.1 Нет данных о ЖК (complex_id)

| | |
|---|---|
| **Проблема** | 0 из 9001 объектов имеют complex_id |
| **Влияние** | Не работает приоритет 1 поиска "тот же ЖК" |

**Варианты решения:**

| # | Решение | Сложность | Точность |
|---|---------|-----------|----------|
| 1 | **Парсинг из заголовка** - искать "ЖК [название]" в title | Низкая | ~70% |
| 2 | **Парсинг из описания** - NLP для извлечения названия ЖК | Средняя | ~80% |
| 3 | **Справочник ЖК + геопривязка** - если координаты попадают в полигон ЖК | Средняя | ~90% |
| 4 | **API LUN.ua** - запрос по координатам для определения ЖК | Низкая | ~95% |

**Рекомендация:** Начать с варианта 1 (regex по заголовку), затем добавить вариант 3.

```javascript
// Пример regex для извлечения ЖК из заголовка
const jkMatch = title.match(/(?:ЖК|жк|Жк)\s*[«"']?([^»"']+)[»"']?/i);
```

---

### 3.2 Нет номера дома (94% объектов)

| | |
|---|---|
| **Проблема** | Только 565 из 9001 (6%) имеют номер дома |
| **Влияние** | Поиск начинается с уровня "улица", а не "дом" |

**Варианты решения:**

| # | Решение | Сложность | Точность |
|---|---------|-----------|----------|
| 1 | **Парсинг из заголовка** - regex для "ул. Название, 123" | Низкая | ~60% |
| 2 | **Reverse geocoding** - по координатам получить адрес через OSM/Google | Средняя | ~85% |
| 3 | **Парсинг из описания** - поиск паттернов адреса | Средняя | ~70% |
| 4 | **Матчинг с базой домов** - сопоставление координат с известными домами | Высокая | ~95% |

**Рекомендация:** Вариант 2 (reverse geocoding) - у нас уже есть OsmModule.

```typescript
// Уже есть в проекте - можно использовать
const address = await this.osmService.reverseGeocode(lat, lng);
```

---

### 3.3 Нет состояния объекта (condition)

| | |
|---|---|
| **Проблема** | 0 из 9001 объектов имеют condition |
| **Влияние** | Критерий "состояние" отключен (weight=0) |

**Варианты решения:**

| # | Решение | Сложность | Точность |
|---|---------|-----------|----------|
| 1 | **Маппинг из атрибутов агрегатора** - Александр приводит к нашим типам | Низкая | ~90% |
| 2 | **Парсинг из описания** - ключевые слова (євроремонт, без ремонту) | Средняя | ~75% |
| 3 | **ML классификация по фото** - анализ фотографий объекта | Высокая | ~85% |

**Рекомендация:** Вариант 1 - ждем маппинг от Александра. Параллельно можно сделать вариант 2.

```typescript
// Ключевые слова для парсинга состояния
const conditionKeywords = {
  'дизайнерський': ['дизайнер', 'авторский', 'эксклюзив'],
  'євроремонт': ['євроремонт', 'евроремонт', 'euro'],
  'житловий': ['житловий', 'жилое', 'заселяйся'],
  'косметичний': ['косметич', 'освеж'],
  'без ремонту': ['без ремонт', 'потребує', 'під ремонт', 'стяжка'],
};
```

---

### 3.4 Нет типа дома (houseType)

| | |
|---|---|
| **Проблема** | 0 из 9001 объектов имеют houseType |
| **Влияние** | Критерий "тип дома" отключен (weight=0) |

**Варианты решения:**

| # | Решение | Сложность | Точность |
|---|---------|-----------|----------|
| 1 | **Маппинг из атрибутов** - Александр приводит к нашим типам | Низкая | ~90% |
| 2 | **Определение по году постройки** - старый фонд (<1970), панель (1970-1990), новострой (>2010) | Низкая | ~70% |
| 3 | **Справочник домов** - база данных с типами домов по адресам | Средняя | ~95% |

**Рекомендация:** Вариант 1 + вариант 2 как fallback.

```typescript
// Определение типа по году постройки
function getHouseTypeByYear(year: number): string {
  if (year >= 2010) return 'моноліт';
  if (year >= 1990) return 'цегла';
  if (year >= 1970) return 'панель';
  return 'старий фонд';
}
```

---

### 3.5 Несоответствие координат и адреса (OLX)

| | |
|---|---|
| **Проблема** | Координаты OLX часто указывают на центр района, а не на дом |
| **Влияние** | Неправильный подбор аналогов по радиусу |

**Варианты решения:**

| # | Решение | Сложность | Точность |
|---|---------|-----------|----------|
| 1 | **Валидация расстояния** - если geocode(адрес) > 500м от координат → использовать geocode | Средняя | ~85% |
| 2 | **Приоритет текстовому адресу** - всегда геокодировать адрес, игнорировать координаты | Низкая | ~80% |
| 3 | **Флаг достоверности** - помечать объекты с подозрительными координатами | Низкая | N/A |

**Рекомендация:** Вариант 1 - валидация с автокоррекцией.

```typescript
async function validateCoordinates(listing: UnifiedListing): Promise<{lat: number, lng: number, isValid: boolean}> {
  const geocoded = await osmService.geocode(listing.address);
  const distance = calculateDistance(listing.lat, listing.lng, geocoded.lat, geocoded.lng);

  if (distance > 500) { // метров
    return { lat: geocoded.lat, lng: geocoded.lng, isValid: false };
  }
  return { lat: listing.lat, lng: listing.lng, isValid: true };
}
```

### 3.6 Сводная таблица решений

| Проблема | Быстрое решение | Надежное решение |
|----------|-----------------|------------------|
| Нет ЖК | Regex из заголовка | Справочник ЖК + геопривязка |
| Нет номера дома | Regex из заголовка | Reverse geocoding (OSM) |
| Нет состояния | Ключевые слова из описания | Маппинг атрибутов (Александр) |
| Нет типа дома | По году постройки | Маппинг атрибутов (Александр) |
| Плохие координаты | Приоритет текстовому адресу | Валидация + автокоррекция |

---

## 4. ROADMAP ДОРАБОТОК

### Фаза 1: Быстрые улучшения (1-2 дня)

| # | Задача | Ответственный | Результат |
|---|--------|---------------|-----------|
| 1 | Парсинг ЖК из заголовка | Разработка | +70% объектов с ЖК |
| 2 | Парсинг состояния из описания | Разработка | +60% объектов с состоянием |
| 3 | Определение типа дома по году | Разработка | +50% объектов с типом |

### Фаза 2: Маппинг атрибутов (ждем Александра)

| # | Задача | Ответственный | Результат |
|---|--------|---------------|-----------|
| 4 | Маппинг condition из атрибутов | Александр → Разработка | +90% объектов с состоянием |
| 5 | Маппинг houseType из атрибутов | Александр → Разработка | +90% объектов с типом |
| 6 | Маппинг complexId | Александр → Разработка | +?% объектов с ЖК |

### Фаза 3: Улучшение геолокации (3-5 дней)

| # | Задача | Ответственный | Результат |
|---|--------|---------------|-----------|
| 7 | Reverse geocoding для номера дома | Разработка | +80% объектов с номером |
| 8 | Валидация координат OLX | Разработка | Точнее подбор по радиусу |
| 9 | Справочник ЖК с полигонами | Разработка + Данные | 95% точность ЖК |

### Фаза 4: После MVP

| Задача | Описание |
|--------|----------|
| Интеграция api_realty_comparison | Дедупликация через embeddings |
| Дополнительные критерии ТЗ | Мебель, окна, коммуникации, вид |
| Пакетная оценка | Batch API для массовой обработки |
| Webhook уведомления | Оповещения об изменении ликвидности |

---

## 5. СТАТИСТИКА БАЗЫ ДАННЫХ

```
Всего объектов:        269,719
├── Активных:            9,618 (3.6%)
└── Неактивных:        260,101 (96.4%)

Квартиры на продажу:     9,001 активных
├── С улицей:            8,940 (99%)
├── С номером дома:        565 (6%)
├── С этажом:            8,995 (99%)
├── С координатами:      9,001 (100%)
├── С состоянием:            0 (0%)
└── С типом дома:            0 (0%)
```

---

## 6. ДЕМОНСТРАЦИЯ

### Шаг 1: Открыть интерфейс
```
http://localhost:3001/
```

### Шаг 2: Ввести URL объекта
```
https://dom.ria.com/uk/realty-prodaja-kvartira-odessa-kievskiy-inglezi-ulitsa-32...
```

### Шаг 3: Показать результаты
- Скоринг ликвидности (0-10)
- Расшифровка по критериям
- Справедливая цена (медиана аналогов)
- Список аналогов с matchScore

### Шаг 4: Показать проблемный объект
```
https://www.olx.ua/d/uk/obyavlenie/prodam-2-komnatnuyu-kvartiru-v-zhk-7-samuraev-na-balkovskoy-IDZsiX8.html
```
- Показать что критерии "состояние" и "тип дома" имеют weight=0
- Объяснить что данные не приходят из источника

---

## 7. ВОПРОСЫ ДЛЯ ОБСУЖДЕНИЯ

1. **ЖК:** Какой источник данных о ЖК использовать?
2. **Атрибуты:** Когда будут приведены типы дома/состояния?
3. **Допуски:** Нужно ли расширить допуск по площади (±5м²)?
4. **OLX:** Как обрабатывать объекты без точного адреса?
5. **Приоритеты:** Какие критерии из ТЗ добавить в первую очередь?
