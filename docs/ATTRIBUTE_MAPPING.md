# Маппинг атрибутов condition і house_type

> Документ описує аналіз та маппінг атрибутів з різних джерел даних у єдиний формат для valuation-service.
>
> **ВАЖЛИВО:** Для платформи realtorUa використовуємо сирі дані з `primary_data.main_params`, а не з `attributes`!

## 1. Обзор источников данных

### 1.1 Vector-API (CRM)
- **Таблица:** `customer_properties`
- **Поле:** `attributes` (JSONB)
- **Справочники:** `attributes` + `attribute_values`
- **Формат значений:** числовые ID → ссылки на `attribute_values.id`

### 1.2 API-Property-Aggregator
- **Таблица:** `exported_properties`
- **Поле:** `attributes` (JSONB)
- **Платформы:** OLX, domRia, realtorUa
- **Формат значений:** числовые ID (должны соответствовать vector-api, но есть расхождения)

---

## 2. Атрибут: condition_type (Стан)

### 2.1 Справочник vector-api (26 значений)

| ID | Название (UK) | Название (RU) | Категория |
|----|---------------|---------------|-----------|
| 69 | Житлове чисте | Жилое чистое | Хороший |
| 81 | Євроремонт | Евроремонт | Отличный |
| 95 | Дах потрібний. ремонт | Крыша треб. ремонт | Требует ремонта |
| 96 | Незавершений ремонт | Незавершенный ремонт | Требует ремонта |
| 97 | Від будівельників вільне планування | От строителей свободная планировка | Новострой |
| 98 | Аварійний | Аварийный | Плохой |
| 99 | Задовільний стан | Удовлетворительное состояние | Средний |
| 100 | Ремонт не потрібний | Ремонт не требуется | Хороший |
| 101 | Стіни сирі | Стены сырые | Плохой |
| 102 | Будматеріали | Стройматериалы | Новострой |
| 103 | Будинок, що будується | Строящийся дом | Новострой |
| 105 | Тільки документи | Только документы | Особый |
| 106 | Потріб. капрем. та дах | Треб. капрем. и крыша | Требует ремонта |
| 107 | Потріб. космет. рем. та дах | Треб. космет. рем. и крыша | Требует ремонта |
| 108 | Потріб. тек. рем. та дах | Треб. тек. рем. и крыша | Требует ремонта |
| 167 | Хороший стан | Хорошее состояние | Хороший |
| 169 | Після будівельників | После строителей | Новострой |
| 173 | Потрібен капітальний ремонт | Требуется капитальный ремонт | Требует ремонта |
| 458 | Потрібен косметичний ремонт | Требуется косметический ремонт | Требует ремонта |
| 459 | Потріб. у тек. ремонті | Нужд. в тек. ремонте | Требует ремонта |
| 476 | Після повені | После наводнения | Плохой |
| 477 | Після пожежі | После пожара | Плохой |
| 787 | Від будівельників (з обробкою) | От строителей (с отделкой) | Новострой |
| 1144 | Дизайнерський ремонт | Дизайнерский ремонт | Отличный |
| 1145 | Чудовий стан | Прекрасное состояние | Отличный |
| 1146 | Перша здача | Первая сдача | Новострой |

### 2.2 Статистика использования в Aggregator (333,935 записей)

| ID | Платформа | Количество | Название |
|----|-----------|------------|----------|
| 81 | все | 145,425 | Євроремонт |
| 169 | все | 56,554 | Після будівельників |
| 69 | olx, realtorUa | 29,313 | Житлове чисте |
| 100 | domRia, realtorUa | 26,314 | Ремонт не потрібний |
| 99 | все | 22,215 | Задовільний стан |
| 167 | domRia | 18,279 | Хороший стан |
| 173 | domRia, realtorUa | 13,393 | Потрібен капітальний ремонт |
| **800** | olx | 10,032 | ⚠️ НЕ СУЩЕСТВУЕТ в condition_type |
| **783** | domRia, realtorUa | 7,256 | ⚠️ НЕ СУЩЕСТВУЕТ в vector-api |
| 97 | realtorUa | 3,673 | Від будівельників вільне планування |
| 458 | realtorUa | 1,063 | Потрібен косметичний ремонт |
| 106 | olx | 404 | Потріб. капрем. та дах |
| 98 | domRia | 14 | Аварійний |

### 2.3 Проблемные ID

#### ID 783 (domRia, realtorUa: 7,256 записей)
- **Статус:** Не существует в `attribute_values`
- **Предположение:** Аналог ID 787 "Від будівельників (з обробкою)"
- **Решение:** Маппить как "Від будівельників (з обробкою)"

#### ID 800 (OLX: 10,032 записей)
- **Статус:** В vector-api это ID из атрибута `appliances` ("Домашній кінотеатр")
- **Предположение:** Ошибка маппинга на стороне OLX, вероятно означает "Після будівельників"
- **Решение:** Маппить как "Після будівельників"

---

## 3. Атрибут: project (Тип дому)

### 3.1 Справочник vector-api (33 значения)

| ID | Название (UK) | Название (RU) | Частота в Aggregator |
|----|---------------|---------------|---------------------|
| 79 | Новобуд | Новострой | 84,807 (55.1%) |
| 76 | Моноліт | Монолит | 17,419 (11.3%) |
| 10 | Старий фонд | Старый фонд | 11,434 (7.4%) |
| 9 | Спецпроект | Спецпроект | 10,438 (6.8%) |
| 83 | Хрущовка | Хрущевка | 7,407 (4.8%) |
| 6 | Московський | Московский | 7,342 (4.8%) |
| 84 | Чеська | Чешский | 7,276 (4.7%) |
| 82 | Сталінка | Сталинка | 3,968 (2.6%) |
| 8 | Сотовий | Сотовый | 2,013 (1.3%) |
| 85 | Гостинка | Гостинка | 1,398 (0.9%) |
| 7 | Прихована вітальня | Скрытая гостинка | 245 (0.2%) |
| 5 | Малосімейка | Малосемейка | 31 (<0.1%) |

**Редко используемые (отсутствуют в Aggregator):**
| ID | Название (UK) |
|----|---------------|
| 3 | Болгарська |
| 4 | Висотний будинок |
| 11 | Харківський |
| 60 | Югославський |
| 86 | Бельгійська |
| 630-644 | Специфические проекты (134, 464, АППС, КП и др.) |
| 723-727 | Польська, Австрійська и люкс варианты |
| 764 | Київка |

### 3.2 Статистика
- Всего записей с project: 153,778 (28.0%)
- Все ID корректно соответствуют справочнику vector-api
- Проблемных ID не обнаружено

---

## 4. Финальный маппинг

### 4.1 condition_type → condition

```typescript
export const CONDITION_TYPE_MAP: Record<number, string> = {
  // Отличный
  81: 'Євроремонт',
  1144: 'Дизайнерський ремонт',
  1145: 'Чудовий стан',

  // Хороший
  69: 'Житлове чисте',
  100: 'Ремонт не потрібний',
  167: 'Хороший стан',

  // Новострой
  97: 'Від будівельників вільне планування',
  102: 'Будматеріали',
  103: 'Будинок, що будується',
  169: 'Після будівельників',
  787: 'Від будівельників (з обробкою)',
  1146: 'Перша здача',

  // Средний
  99: 'Задовільний стан',
  96: 'Незавершений ремонт',

  // Требует ремонта
  95: 'Дах потрібний ремонт',
  106: 'Потріб. капрем. та дах',
  107: 'Потріб. космет. рем. та дах',
  108: 'Потріб. тек. рем. та дах',
  173: 'Потрібен капітальний ремонт',
  458: 'Потрібен косметичний ремонт',
  459: 'Потріб. у тек. ремонті',

  // Плохой
  98: 'Аварійний',
  101: 'Стіни сирі',
  476: 'Після повені',
  477: 'Після пожежі',

  // Особый
  105: 'Тільки документи',

  // === ИСПРАВЛЕНИЯ ДЛЯ AGGREGATOR ===
  783: 'Від будівельників (з обробкою)', // domRia/realtorUa → аналог 787
  800: 'Після будівельників',            // OLX → аналог 169
};
```

### 4.2 project → house_type

```typescript
export const PROJECT_TYPE_MAP: Record<number, string> = {
  // Современные
  79: 'Новобуд',
  76: 'Моноліт',
  4: 'Висотний будинок',

  // Советские
  83: 'Хрущовка',
  82: 'Сталінка',
  6: 'Московський',
  84: 'Чеська',
  3: 'Болгарська',
  11: 'Харківський',
  60: 'Югославський',

  // Спецпроекты
  9: 'Спецпроект',
  10: 'Старий фонд',
  8: 'Сотовий',

  // Малометражки
  5: 'Малосімейка',
  85: 'Гостинка',
  7: 'Прихована вітальня',

  // Европейские
  86: 'Бельгійська',
  723: 'Польська',
  724: 'Польський люкс',
  725: 'Польський напівлюкс',
  726: 'Австрійська',
  727: 'Австрійський люкс',
  764: 'Київка',
  644: 'Царський (дореволюційний)',

  // Серии домов
  630: '134',
  631: '464',
  632: '96',
  633: 'АПВС',
  634: 'АППС',
  635: 'АППС люкс',
  637: 'БПС',
  638: 'КП',
  639: 'КТ',
  640: 'КТУ',
  641: 'Т1',
  642: 'Т2',
  643: 'Т4',
};
```

---

## 5. Нормализованные категории для ликвидности

### 5.1 Категории condition (для скоринга)

| Категория | Значения | Балл ликвидности |
|-----------|----------|------------------|
| excellent | Євроремонт, Дизайнерський ремонт, Чудовий стан | 10 |
| good | Житлове чисте, Ремонт не потрібний, Хороший стан | 8 |
| new_build | Після будівельників, Від будівельників*, Перша здача, Будматеріали | 7 |
| average | Задовільний стан, Незавершений ремонт | 5 |
| needs_repair | Потрібен *ремонт, Дах потрібний ремонт | 3 |
| poor | Аварійний, Стіни сирі, Після повені/пожежі | 1 |

### 5.2 Категории house_type (для скоринга)

| Категория | Значения | Балл ликвидности |
|-----------|----------|------------------|
| modern | Новобуд, Моноліт, Висотний будинок | 10 |
| quality_soviet | Сталінка, Чеська, Царський | 8 |
| standard_soviet | Московський, Болгарська, Харківський | 6 |
| economy | Хрущовка, Малосімейка, Гостинка | 4 |
| special | Спецпроект, Старий фонд | 5 |

---

## 6. Рекомендации

1. **Обновить process-aggregator-dump.ts** с полным маппингом включая 783 и 800
2. **Добавить логирование** неизвестных ID для мониторинга новых значений
3. **Перезапустить импорт** для обновления condition и house_type
4. **Рассмотреть feedback** в aggregator о некорректных ID (783, 800)

---

## 7. Маппінг для realtorUa (з primary_data)

> Для платформи realtorUa маппінг виконується з сирих даних `primary_data.main_params.status` та `primary_data.main_params.border`

### 7.1 status → condition (за вимогами менеджера)

| Сире значення (realtorUa) | Кількість | Маппінг у vector |
|---------------------------|-----------|------------------|
| Євроремонт | 33,541 | Євроремонт |
| Від будівельників (з обробкою) | 18,429 | Після будівельників |
| Від будівельників вільне планування | 10,692 | Після будівельників |
| Дизайнерський ремонт | 19,420 | Євроремонт |
| Задовільний стан | 7,414 | Житлове чисте |
| Незавершений ремонт | 3,001 | Потрібен косметичний ремонт |
| Перша здача | 655 | Житлове чисте |
| Потрібен капітальний ремонт | 3,366 | Потрібен капітальний ремонт |
| Потрібен косметичний ремонт | 3,301 | Потрібен косметичний ремонт |
| Хороший стан | 21,473 | Житлове чисте |
| Чудовий стан | 10,419 | Євроремонт |
| **З ремонтом** | 38,455 | Хороший стан *(нове)* |
| **Без ремонту** | 22,000 | Потрібен косметичний ремонт *(нове)* |
| **Частковий ремонт** | 6,489 | Хороший стан *(нове)* |
| null | 30,718 | - |

### 7.2 border → house_type (за вимогами менеджера)

| Сире значення (realtorUa) | Кількість | Маппінг у vector |
|---------------------------|-----------|------------------|
| Бетонно монолітний | 25,918 | Моноліт |
| Будинок | 39,359 | Будинок |
| Газоблок | 4,866 | Газобетон |
| Дача | 990 | Дача |
| Дореволюційний | 2,249 | Старий фонд |
| Дуплекс | 4,269 | Дуплекс |
| Котедж | 4,302 | Котедж |
| Сталінка | 1,924 | Сталінка |
| Стара панель | 870 | Хрущовка |
| Стара цегла | 4,100 | Сталінка |
| Таунхаус | 8,166 | Таунхаус |
| Типова панель | 5,588 | Чеська |
| Українська панель | 4,199 | Харківський |
| Українська цегла | 24,231 | Спецпроект |
| Флігель | 20 | - |
| Частина будинку | 901 | Частина будинку |
| **Монолітно-каркасна** | 8,577 | Моноліт *(нове)* |
| **Цегляна** | 7,823 | Спецпроект *(нове)* |
| **Утеплена панель** | 1,921 | Чеська *(нове)* |
| **Панельна** | 1,847 | Хрущовка *(нове)* |
| **Блочна** | 948 | Спецпроект *(нове)* |
| null | 76,305 | - |

### 7.3 TypeScript константи

```typescript
/**
 * Маппінг сирих значень status з realtorUa → нормалізоване condition
 */
export const REALTOR_UA_STATUS_MAP: Record<string, string> = {
  // Від менеджера
  'Євроремонт': 'Євроремонт',
  'Від будівельників (з обробкою)': 'Після будівельників',
  'Від будівельників вільне планування': 'Після будівельників',
  'Дизайнерський ремонт': 'Євроремонт',
  'Задовільний стан': 'Житлове чисте',
  'Незавершений ремонт': 'Потрібен косметичний ремонт',
  'Перша здача': 'Житлове чисте',
  'Потрібен капітальний ремонт': 'Потрібен капітальний ремонт',
  'Потрібен косметичний ремонт': 'Потрібен косметичний ремонт',
  'Хороший стан': 'Житлове чисте',
  'Чудовий стан': 'Євроремонт',
  // Нові значення (не було в маппінгу менеджера)
  'З ремонтом': 'Хороший стан',
  'Без ремонту': 'Потрібен косметичний ремонт',
  'Частковий ремонт': 'Хороший стан',
};

/**
 * Маппінг сирих значень border з realtorUa → нормалізоване house_type
 */
export const REALTOR_UA_BORDER_MAP: Record<string, string> = {
  // Від менеджера
  'Бетонно монолітний': 'Моноліт',
  'Будинок': 'Будинок',
  'Газоблок': 'Газобетон',
  'Дача': 'Дача',
  'Дореволюційний': 'Старий фонд',
  'Дуплекс': 'Дуплекс',
  'Котедж': 'Котедж',
  'Сталінка': 'Сталінка',
  'Стара панель': 'Хрущовка',
  'Стара цегла': 'Сталінка',
  'Таунхаус': 'Таунхаус',
  'Типова панель': 'Чеська',
  'Українська панель': 'Харківський',
  'Українська цегла': 'Спецпроект',
  'Частина будинку': 'Частина будинку',
  // Нові значення
  'Монолітно-каркасна': 'Моноліт',
  'Цегляна': 'Спецпроект',
  'Утеплена панель': 'Чеська',
  'Панельна': 'Хрущовка',
  'Блочна': 'Спецпроект',
};
```

---

## 8. Маппінг для OLX (з primary_data.params)

> Для платформи OLX маппінг виконується з сирих даних `primary_data.params` - масиву об'єктів з key/value

### 8.1 repair → condition

| Сире значення (OLX) | Кількість | Маппінг у vector |
|---------------------|-----------|------------------|
| Євроремонт | 108,681 | Євроремонт |
| Після будівельників | 65,635 | Після будівельників |
| Авторський проект | 58,912 | Євроремонт |
| Житловий стан | 41,391 | Житлове чисте |
| Косметичний ремонт | 25,410 | Хороший стан |
| Під чистову обробку | 15,601 | Після будівельників |
| Аварійний стан | 712 | Потрібен капітальний ремонт |

### 8.2 property_type_appartments_sale → house_type

| Сире значення (OLX) | Кількість | Маппінг у vector |
|---------------------|-----------|------------------|
| Житловий фонд від 2021 р. | 79,610 | Новобуд |
| Житловий фонд 2011-2020-і | 48,025 | Новобуд |
| Житловий фонд 2001-2010-і | 11,960 | Спецпроект |
| Чешка | 10,728 | Чеська |
| Хрущовка | 10,423 | Хрущовка |
| Житловий фонд 80-90-і | 8,932 | Спецпроект |
| Царський будинок | 8,384 | Старий фонд |
| Житловий фонд 91-2000-і | 5,235 | Спецпроект |
| Сталінка | 4,853 | Сталінка |
| Гостинка | 1,961 | Гостинка |
| Совмін | 1,721 | Спецпроект |
| Будинок до 1917 року | 1,269 | Старий фонд |
| Гуртожиток | 394 | Гостинка |
| Житловий фонд від 2011 р. | 3 | Новобуд |

### 8.3 TypeScript константи

```typescript
/**
 * Маппінг сирих значень repair з OLX → нормалізоване condition
 * Джерело: primary_data.params де key='repair'
 */
export const OLX_REPAIR_MAP: Record<string, string> = {
  'Євроремонт': 'Євроремонт',
  'Після будівельників': 'Після будівельників',
  'Авторський проект': 'Євроремонт',
  'Житловий стан': 'Житлове чисте',
  'Косметичний ремонт': 'Хороший стан',
  'Під чистову обробку': 'Після будівельників',
  'Аварійний стан': 'Потрібен капітальний ремонт',
};

/**
 * Маппінг сирих значень property_type_appartments_sale з OLX → нормалізоване house_type
 * Джерело: primary_data.params де key='property_type_appartments_sale'
 */
export const OLX_PROPERTY_TYPE_MAP: Record<string, string> = {
  // Новобудови
  'Житловий фонд від 2021 р.': 'Новобуд',
  'Житловий фонд 2011-2020-і': 'Новобуд',
  'Житловий фонд від 2011 р.': 'Новобуд',
  'Житловий фонд 2001-2010-і': 'Спецпроект',
  // Радянський фонд
  'Чешка': 'Чеська',
  'Хрущовка': 'Хрущовка',
  'Житловий фонд 80-90-і': 'Спецпроект',
  'Житловий фонд 91-2000-і': 'Спецпроект',
  'Сталінка': 'Сталінка',
  'Гостинка': 'Гостинка',
  'Совмін': 'Спецпроект',
  'Гуртожиток': 'Гостинка',
  // Старий фонд
  'Царський будинок': 'Старий фонд',
  'Будинок до 1917 року': 'Старий фонд',
};
```

---

## 9. Маппінг для domRia (з primary_data)

> Для платформи domRia маппінг виконується з:
> - `primary_data.characteristics_values[516]` для condition
> - `primary_data.wall_type` для house_type

### 9.1 characteristics_values[516] → condition

Ключ 516 в domRia API відповідає за "стан ремонту". Значення - числові ID:

| ID | Опис | Маппінг у vector |
|----|------|------------------|
| 507 | від будівельників | Після будівельників |
| 508 | потребує капремонту | Потрібен капітальний ремонт |
| 509 | потребує косметичного ремонту | Потрібен косметичний ремонт |
| 510 | євроремонт | Євроремонт |
| 511 | житловий стан | Житлове чисте |
| 512 | хороший стан | Хороший стан |
| 513 | чорнова обробка | Після будівельників |
| 514 | передчистова обробка | Після будівельників |
| 515 | дизайнерський ремонт | Євроремонт |

### 9.2 wall_type → house_type

| Сире значення (domRia) | Кількість | Маппінг у vector |
|------------------------|-----------|------------------|
| кирпич | 122,955 | Спецпроект |
| панель | 21,024 | Хрущовка |
| газоблок | 18,162 | Газобетон |
| монолитно-каркасный | 17,822 | Моноліт |
| монолит | 7,749 | Моноліт |
| газобетон | 6,106 | Газобетон |
| керамический блок | 5,118 | Спецпроект |
| монолитно-кирпичный | 3,833 | Моноліт |
| пеноблок | 2,980 | Газобетон |
| железобетон | 2,920 | Моноліт |
| ракушечник (ракушняк) | 2,023 | Спецпроект |
| керамзитобетон | 1,914 | Спецпроект |
| монолитно-блочный | 1,722 | Моноліт |
| силикатный кирпич | 821 | Спецпроект |
| монолитный железобетон | 529 | Моноліт |
| красный кирпич | 409 | Спецпроект |
| блочно-кирпичный | 370 | Спецпроект |
| керамический кирпич | 330 | Спецпроект |
| цегла | 138 | Спецпроект |
| null | 40,705 | - |

### 9.3 TypeScript константи

```typescript
/**
 * Маппінг characteristics_values[516] з domRia → нормалізоване condition
 * 516 - це ID характеристики "стан ремонту" в domRia
 */
export const DOMRIA_CONDITION_MAP: Record<number, string> = {
  507: 'Після будівельників',    // від будівельників
  508: 'Потрібен капітальний ремонт', // потребує капремонту
  509: 'Потрібен косметичний ремонт', // потребує косметичного ремонту
  510: 'Євроремонт',             // євроремонт
  511: 'Житлове чисте',          // житловий стан
  512: 'Хороший стан',           // хороший стан
  513: 'Після будівельників',    // чорнова обробка
  514: 'Після будівельників',    // передчистова обробка
  515: 'Євроремонт',             // дизайнерський ремонт
};

/**
 * Маппінг wall_type з domRia → нормалізоване house_type
 * Джерело: primary_data.wall_type
 */
export const DOMRIA_WALL_TYPE_MAP: Record<string, string> = {
  'кирпич': 'Спецпроект',
  'панель': 'Хрущовка',
  'газоблок': 'Газобетон',
  'монолитно-каркасный': 'Моноліт',
  'монолит': 'Моноліт',
  'газобетон': 'Газобетон',
  'керамический блок': 'Спецпроект',
  'монолитно-кирпичный': 'Моноліт',
  'пеноблок': 'Газобетон',
  'железобетон': 'Моноліт',
  'ракушечник (ракушняк)': 'Спецпроект',
  'керамзитобетон': 'Спецпроект',
  'монолитно-блочный': 'Моноліт',
  'силикатный кирпич': 'Спецпроект',
  'монолитный железобетон': 'Моноліт',
  'красный кирпич': 'Спецпроект',
  'блочно-кирпичный': 'Спецпроект',
  'керамический кирпич': 'Спецпроект',
  'цегла': 'Спецпроект',
};
```

---

## 10. Підсумок реалізації

### 10.1 Архітектура маппінгу

```
primary_data (сирі дані з платформи)
       │
       ├── realtorUa
       │   ├── main_params.status → mapRealtorUaCondition() → condition
       │   └── main_params.border → mapRealtorUaHouseType() → house_type
       │
       ├── OLX
       │   ├── params[key='repair'] → mapOlxCondition() → condition
       │   └── params[key='property_type_appartments_sale'] → mapOlxHouseType() → house_type
       │
       └── domRia
           ├── characteristics_values[516] → mapDomriaCondition() → condition
           └── wall_type → mapDomriaHouseType() → house_type
```

### 10.2 Пріоритет даних

1. **Спочатку** - маппінг з `primary_data` за платформою
2. **Fallback** - маппінг з `attributes` по ID (для зворотної сумісності)
3. **Fallback 2** - текстове значення з `attributes` без маппінгу

### 10.3 Логування невідомих значень

Скрипт логує всі невідомі значення:
- `unknownOlxRepairs` - нові значення repair на OLX
- `unknownOlxPropertyTypes` - нові типи нерухомості на OLX
- `unknownDomriaConditions` - нові ID станів на domRia
- `unknownDomriaWallTypes` - нові типи стін на domRia
- `unknownRealtorUaStatuses` - нові статуси на realtorUa
- `unknownRealtorUaBorders` - нові типи будинків на realtorUa

---

*Дата аналізу: 2024-12-27*
*Оновлено: 2024-12-27 (додано маппінг OLX та domRia з primary_data)*
*Проаналізовано записів: ~550,000 (всі платформи в aggregator_import)*
