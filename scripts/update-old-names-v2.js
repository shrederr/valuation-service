const { Client } = require('pg');

// 2024 переименования (украинские названия)
const renames2024 = [
  { new: "Вулиця Михайла Болтенка", old: "Вулиця Адмірала Лазарєва" },
  { new: "Вулиця Віталія Нестеренка", old: "Вулиця Академіка Воробйова" },
  { new: "Проспект Князя Ярослава Мудрого", old: "Проспект Академіка Глушка" },
  { new: "Вулиця Дмитра Сигаревича", old: "Вулиця Академіка Панкратової" },
  { new: "Вулиця Михайла Білинського", old: "Вулиця Амвросія Бучми" },
  { new: "Провулок Зої Пасічної", old: "Провулок Апполона Скальковського" },
  { new: "Вулиця Незалежності", old: "Вулиця Армійська" },
  { new: "Вулиця Дмитра Іванова", old: "Вулиця Бабеля" },
  { new: "Вулиця Михайла Бойчука", old: "Вулиця Багрицького" },
  { new: "Провулок Марії Станішевської", old: "Провулок Бадаєва" },
  { new: "Провулок Дмитра Лесича", old: "Провулок Барятинський" },
  { new: "Вулиця Василя Фащенка", old: "Вулиця Братів Поджіо" },
  { new: "Вулиця Ніни Строкатої", old: "Вулиця Буніна" },
  { new: "Вулиця Ярослава Баїса", old: "Вулиця Висоцького" },
  { new: "Вулиця Андрія Гулого-Гуленка", old: "Вулиця Віце-адмірала Азарова" },
  { new: "Провулок Івана Луценка", old: "Провулок Віце-адмірала Жукова" },
  { new: "Вулиця Володимира Рутківського", old: "Вулиця Віри Інбер" },
  { new: "Вулиця Семена Комірного", old: "Вулиця Гагаріна" },
  { new: "Провулок Михайла Гордієвського", old: "Провулок Гагаріна" },
  { new: "Проспект Лесі Українки", old: "Проспект Гагаріна" },
  { new: "Аркадійське плато", old: "Гагарінське плато" },
  { new: "Вулиця Павла Клепацького", old: "Вулиця Гаріна" },
  { new: "Вулиця Андрія Музичка", old: "Вулиця Гвардійська" },
  { new: "Вулиця Станіслава Узікова", old: "Вулиця Генерала Гудовича" },
  { new: "Вулиця Євгена Танцюри", old: "Вулиця Генерала Петрова" },
  { new: "Вулиця Ростислава Палецького", old: "Вулиця Генерала Ратова" },
  { new: "Вулиця Григорія Зленка", old: "Вулиця Генерала Швигіна" },
  { new: "Вулиця Геннадія Афанасьєва", old: "Вулиця Генерала Цвєтаєва" },
  { new: "Вулиця Галини Могильницької", old: "Вулиця Герцена" },
  { new: "Вулиця Тараса Кузьміна", old: "Вулиця Градоначальницька" },
  { new: "Сквер Юрія Ілленка", old: "Сквер Двічі Героя Радянського Союзу Захарова" },
  { new: "Вулиця Всеволода Змієнка", old: "Вулиця Дворянська" },
  { new: "Проспект Князя Володимира Великого", old: "Проспект Добровольського" },
  { new: "Площа Біржова", old: "Площа Думська" },
  { new: "Вулиця Олександра Кошиця", old: "Вулиця Дунаєвського" },
  { new: "Бульвар Військово-морських сил", old: "Бульвар Жванецького" },
  { new: "Вулиця Святослава Караванського", old: "Вулиця Жуковського" },
  { new: "Вулиця Сім'ї Глодан", old: "Вулиця Ільфа і Петрова" },
  { new: "Провулок Сергія Коновалова", old: "Провулок Інтернаціональний" },
  { new: "Провулок Бориса Айзенберга", old: "Провулок Катаєва" },
  { new: "Вулиця Олексія Маркевича", old: "Вулиця Князівська" },
  { new: "Вулиця Павла Зеленого", old: "Вулиця Коблевська" },
  { new: "Вулиця Віталія Гуляєва", old: "Вулиця Контр-адмірала Луніна" },
  { new: "Провулок Ігоря Балмагії", old: "Провулок Короленка" },
  { new: "Вулиця Січових стрільців", old: "Вулиця Леваневського" },
  { new: "Провулок Січовий", old: "Провулок Леваневського" },
  { new: "Вулиця Олександра Станкова", old: "Вулиця Лейтенанта Шмідта" },
  { new: "Провулок Госпітальєрів", old: "Провулок Лермонтовський 2й" },
  { new: "Вулиця Кіри Муратової", old: "Вулиця Льва Толстого" },
  { new: "Площа Менделя Сфоріма", old: "Площа Льва Толстого" },
  { new: "Провулок Олександра Ройтбурда", old: "Провулок Ляпунових" },
  { new: "Вулиця Михайла Омеляновича-Павленка", old: "Вулиця Маріїнська" },
  { new: "Узвіз Віталія Блажка", old: "Узвіз Марінеско" },
  { new: "Вулиця Івана Фунтового", old: "Вулиця Маршала Бабаджаняна" },
  { new: "Вулиця Олексія Вадатурського", old: "Вулиця Маршала Малиновського" },
  { new: "Провулок Маргарити Ніколаєвої", old: "Провулок Мічуріна" },
  { new: "Провулок Олекси Воропая", old: "Провулок Митракова" },
  { new: "Вулиця Анатолія Бачинського", old: "Вулиця Недєліна" },
  { new: "Провулок Леоніда Осики", old: "Провулок Олександра Стурдзи" },
  { new: "Вулиця Вадима Корженка", old: "Вулиця Осипова" },
  { new: "Вулиця 28 бригади", old: "Вулиця Паустовського" },
  { new: "Сквер Номана Челебіджіхана", old: "Сквер Паустовського" },
  { new: "Вулиця Олександра Болдирєва", old: "Вулиця Петра Біциллі" },
  { new: "Провулок Георгія Гусака-Гусаченка", old: "Провулок Ползунова 2-й" },
  { new: "Вулиця Архітектора Івана Яценка", old: "Вулиця Політкаторжан" },
  { new: "Вулиця Італійська", old: "Вулиця Пушкінська" },
  { new: "Вулиця Решата Аметова", old: "Вулиця Романа Кармена" },
  { new: "Вулиця Миколи Савича", old: "Вулиця Сабаньєв міст" },
  { new: "Сквер Дмитра Дорошенка", old: "Сквер Серединський" },
  { new: "Вулиця Ганни Михайленко", old: "Вулиця Спартаківська" },
  { new: "Провулок Костянтина Пігрова", old: "Провулок Спартаківський" },
  { new: "Вулиця Максима Чайки", old: "Вулиця Строганова" },
  { new: "Провулок Володимира Яковлева", old: "Провулок Стурдзовський" },
  { new: "Провулок Гетьманський", old: "Провулок Тимірязева 1-й" },
  { new: "Провулок Гайдамацький", old: "Провулок Тимірязева 2-й" },
  { new: "Провулок Козацький", old: "Провулок Тимірязева 3-й" },
  { new: "Провулок Характерників", old: "Провулок Тимірязева 4-й" },
  { new: "Провулок Кобзарський", old: "Провулок Тимірязева 5-й" },
  { new: "Вулиця Георгія Липського", old: "Вулиця Толбухіна" },
  { new: "Провулок Людмили Семикіної", old: "Провулок Толбухіна" },
  { new: "Площа Трибуни героїв", old: "Площа Толбухіна" },
  { new: "Провулок Театральний", old: "Провулок Чайковського" },
  { new: "Вулиця Артура Савельєва", old: "Вулиця Черняховського" },
  { new: "Вулиця Віталія Боровика", old: "Вулиця Юрія Олеші" },
  // Дополнительные из предыдущего списка
  { new: "вулиця Добровольців", old: "вулиця Маршала Говорова" },
  { new: "вулиця Петра Лещенка", old: "вулиця Комінтерну" },
  { new: "Дерибасівська вулиця", old: "вулиця Рішельєвська" },
];

function normalizeStreetName(name) {
  if (!name) return '';
  return name
    .toLowerCase()
    .replace(/[''ʼ`]/g, "'")
    .replace(/^(вулиця|вул\.|вул|улица|ул\.|ул|проспект|просп\.|пр-т|пр\.|провулок|пров\.|переулок|пер\.|бульвар|бульв\.|б-р|площа|пл\.|площадь|набережна|наб\.|шосе|шоссе|алея|проїзд|проезд|узвіз|спуск|тупик|майдан|дорога|сквер|парк|плато)\s*/gi, '')
    .replace(/\s+(вулиця|улица|проспект|провулок|переулок|бульвар|площа|площадь|набережна|шосе|шоссе|алея|проїзд|проезд|узвіз|спуск|тупик|майдан|дорога|сквер|парк|плато)$/gi, '')
    .replace(/[«»""''`]/g, '')
    .replace(/[–—−]/g, '-')
    .replace(/\s+/g, ' ')
    .trim();
}

async function main() {
  const client = new Client({
    connectionString: 'postgresql://postgres:postgis_valuation_2024@maglev.proxy.rlwy.net:38842/valuation'
  });
  await client.connect();

  console.log('=== Обновление старых названий улиц Одессы (2024) ===\n');

  const odesaGeoIds = [18271, 19314, 19315, 19316, 19317];

  const streetsResult = await client.query(`
    SELECT id, name->>'uk' as name_uk, names
    FROM streets
    WHERE geo_id IN (${odesaGeoIds.join(',')})
  `);

  console.log(`Улиц в Одессе: ${streetsResult.rows.length}`);

  // Создаём карту переименований
  const renameMap = new Map();
  for (const r of renames2024) {
    const normNew = normalizeStreetName(r.new);
    if (!renameMap.has(normNew)) {
      renameMap.set(normNew, []);
    }
    renameMap.get(normNew).push(r.old);
  }

  console.log(`Правил переименования: ${renameMap.size}\n`);

  let updated = 0;
  let matched = 0;

  for (const street of streetsResult.rows) {
    const nameUk = street.name_uk || '';
    const normUk = normalizeStreetName(nameUk);

    let oldNames = renameMap.get(normUk);

    if (oldNames && oldNames.length > 0) {
      matched++;

      const currentNames = street.names || { uk: [], ru: [], en: [] };
      const currentUk = currentNames.uk || [];

      let needUpdate = false;
      const newUk = [...currentUk];

      if (nameUk && !newUk.includes(nameUk)) {
        newUk.unshift(nameUk);
        needUpdate = true;
      }

      for (const oldName of oldNames) {
        if (!newUk.some(n => normalizeStreetName(n) === normalizeStreetName(oldName))) {
          newUk.push(oldName);
          needUpdate = true;
        }
      }

      if (needUpdate) {
        const newNames = { ...currentNames, uk: newUk };

        await client.query(
          'UPDATE streets SET names = $1 WHERE id = $2',
          [JSON.stringify(newNames), street.id]
        );
        updated++;

        if (updated <= 30) {
          console.log(`✓ ${street.id}: ${nameUk}`);
          console.log(`  + ${oldNames.join(', ')}`);
        }
      }
    }
  }

  console.log(`\n=== Результат ===`);
  console.log(`Найдено совпадений: ${matched}`);
  console.log(`Обновлено улиц: ${updated}`);

  // Статистика
  const stats = await client.query(`
    SELECT
      COUNT(*) as total,
      COUNT(*) FILTER (WHERE jsonb_array_length(names->'uk') > 1) as with_old_names
    FROM streets
    WHERE geo_id IN (${odesaGeoIds.join(',')})
  `);
  console.log(`\nУлиц со старыми названиями: ${stats.rows[0].with_old_names}/${stats.rows[0].total}`);

  await client.end();
}

main().catch(console.error);
